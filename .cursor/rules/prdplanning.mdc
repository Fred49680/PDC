---
alwaysApply: true
---
PRD â€” Planning v3
Gestion des besoins et affectations par Affaire / CompÃ©tence / PÃ©riode
1. Objectif produit (corrigÃ©)

Permettre de planifier, par AFFAIRE, les besoins en ressources par compÃ©tence et par pÃ©riode, puis dâ€™y affecter des ressources :

sans conflit multi-affaires,

en respectant absences, jours ouvrÃ©s, transferts,

avec une interface lisible, robuste et performante,

sans grille â€œExcelâ€ lourde Ã  maintenir.

2. PÃ©rimÃ¨tre fonctionnel
Inclus

Besoins par affaire

Plusieurs pÃ©riodes par compÃ©tence et par affaire

Affectations liÃ©es Ã  une affaire

DÃ©tection :

absences

conflits inter-affaires

week-ends / jours fÃ©riÃ©s

Ressources :

locales

transfÃ©rÃ©es

externes

CrÃ©ation / extension automatique des transferts

Actions de masse (besoins et affectations)

Consolidation automatique des pÃ©riodes

Exclus (volontairement)

Ã‰dition en grille JOURÃ—RESSOURCE

Double-clic cachÃ©

Logique mÃ©tier dispersÃ©e dans les composants UI

3. ModÃ¨le conceptuel (clÃ© du sujet)
Axe principal
AFFAIRE
 â””â”€â”€ COMPÃ‰TENCE
      â””â”€â”€ PÃ‰RIODE DE BESOIN (0..n)
           â””â”€â”€ AFFECTATIONS (0..n ressources)


ğŸ‘‰ Une compÃ©tence peut avoir plusieurs pÃ©riodes distinctes pour une mÃªme affaire
ğŸ‘‰ Une ressource peut Ãªtre affectÃ©e Ã  une seule affaire Ã  la fois

4. ModÃ¨le de donnÃ©es (frontend & backend)
4.1 Besoin (corrigÃ©)
type BesoinPeriode = {
  id: string

  affaireId: string
  site: string

  competence: string

  dateDebut: Date
  dateFin: Date

  nbRessources: number

  couverture: {
    affecte: number
    manque: number
    surplus: number
  }
}

Contraintes

(affaireId, competence, dateDebut, dateFin) unique

Les pÃ©riodes peuvent se chevaucher entre compÃ©tences, jamais dans une mÃªme compÃ©tence consolidÃ©e

4.2 Affectation
type Affectation = {
  id: string

  affaireId: string
  site: string

  ressourceId: string
  competence: string

  dateDebut: Date
  dateFin: Date

  charge: number // v1 = 1
}

5. Vue principale â€” Besoins par Affaire
5.1 Structure Ã©cran
Affaire XYZ â€” Site ABC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[CompÃ©tence A]
  â€¢ 02/01 â†’ 10/01 | Besoin 2 | AffectÃ© 1 | âŒ
  â€¢ 15/01 â†’ 25/01 | Besoin 1 | AffectÃ© 1 | âœ…

[CompÃ©tence B]
  â€¢ 05/01 â†’ 20/01 | Besoin 3 | AffectÃ© 2 | âš ï¸

5.2 Comportement

Groupement par compÃ©tence

Chaque pÃ©riode est indÃ©pendante

Indicateur clair :

ğŸŸ¢ OK

ğŸŸ  Sous-affectÃ©

ğŸ”´ Sur-affectÃ©

Actions visibles sur chaque pÃ©riode :

[Affecter]

[Modifier]

[Supprimer]

5.3 RÃ¨gles mÃ©tier (besoins)

Un besoin :

appartient Ã  UNE affaire

concerne UNE compÃ©tence

couvre une pÃ©riode continue

Les jours non ouvrÃ©s sont exclus Ã  la crÃ©ation

Les pÃ©riodes sont consolidÃ©es automatiquement

Une compÃ©tence peut avoir N pÃ©riodes

6. Panneau latÃ©ral â€” Affectation (par pÃ©riode de besoin)
6.1 DÃ©clenchement

Clic sur [Affecter] dâ€™une pÃ©riode donnÃ©e.

Contexte injectÃ© :

{
  affaireId,
  site,
  competence,
  dateDebut,
  dateFin,
  nbRessourcesRequises
}

6.2 Ressources candidates

FiltrÃ©es par :

compÃ©tence

disponibilitÃ© sur la pÃ©riode

absence

conflits avec autres affaires

type RessourceCandidat = {
  id: string
  nom: string
  site: string

  isPrincipale: boolean
  isAbsente: boolean
  hasConflit: boolean
  necessiteTransfert: boolean

  selectable: boolean
}

6.3 RÃ¨gles de sÃ©lection

Une ressource :

âŒ ne peut pas Ãªtre affectÃ©e Ã  2 affaires simultanÃ©ment

âŒ ne peut pas Ãªtre affectÃ©e pendant une absence

âœ… peut nÃ©cessiter un transfert (auto-crÃ©Ã©)

SÃ©lection multi-ressources

Compteur dynamique : 2 / 3 ressources sÃ©lectionnÃ©es

6.4 Validation

Ã€ la validation :

VÃ©rification finale (absences + conflits)

CrÃ©ation / extension des transferts

CrÃ©ation des affectations

Consolidation

Refresh vue besoins

ğŸ‘‰ Transaction logique â€œtout ou rienâ€

7. Actions de masse (corrigÃ©es)
7.1 CrÃ©ation de besoins de masse

Depuis lâ€™affaire :

Modal :

compÃ©tence

date dÃ©but

date fin

nb ressources

RÃ¨gles :

uniquement jours ouvrÃ©s

consolidation automatique

crÃ©ation de 1..N pÃ©riodes selon les rÃ¨gles mÃ©tier

7.2 Affectation automatique (par pÃ©riode)

Depuis le panneau dâ€™affectation :

Bouton [Auto-affecter]

Ordre de prioritÃ© v1 :

Ressources du site

CompÃ©tence principale

Pas de conflit

Pas de transfert requis

Sinon transfert externe

8. Architecture technique (mise Ã  jour)
8.1 Organisation du code
/planning
 â”œâ”€ planning.rules.ts       // jours ouvrÃ©s, conflits, absences
 â”œâ”€ planning.compute.ts    // couverture, candidats
 â”œâ”€ planning.api.ts        // Supabase RPC
 â”œâ”€ BesoinsList.tsx
 â”œâ”€ BesoinCard.tsx
 â”œâ”€ AffectationPanel.tsx
 â””â”€ PlanningAffairePage.tsx

8.2 Backend (fortement recommandÃ©)

RPC Supabase :

get_besoins_affaire(affaire_id, start, end)

get_couverture_besoin(besoin_id)

get_ressources_candidates(besoin_id)

apply_affectations_batch(payload)

create_or_extend_transfert(...)

9. CritÃ¨res de succÃ¨s

1 affaire comprÃ©hensible en < 10 secondes

Pas de grille massive

Pas de double-clic

Pas de recalcul lourd cÃ´tÃ© front

ZÃ©ro conflit possible Ã  la validation

10. Conclusion franche

ğŸ‘‰ Le besoin par affaire + plusieurs pÃ©riodes par compÃ©tence est maintenant nativement intÃ©grÃ©.
ğŸ‘‰ Ce PRD est alignÃ© avec ton modÃ¨le actuel, sans te piÃ©ger dans une UI ingÃ©rable.
ğŸ‘‰ Tu peux coder par itÃ©ration, sans casser ta v2.